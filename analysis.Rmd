---
title: "Sync-Async Analysis"
author: "Joshua M. Rosenberg & K. Bret Staudt Willet"
date: "2/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
usethis::use_git_ignore(c("*.csv", "*.rds"))
```

# Loading, setting up

```{r, include=FALSE}
library(tidyverse)
library(rtweet)
library(lubridate)
#library(devtools)  # need to install if not installed
#devtools::install_github("jrosen48/tidyttest")  # only need to run once
library(tidyttest)

#df_ss <- read_rds("snyc_async_tweets_full_metadata.rds")
df_ss <- read_csv("snyc_async_tweets_full_metadata_liwc.csv", skip=1)

names(df_ss)[1:91] <- c("user_id", "status_id", "created_at", "screen_name", "text", 
"source", "display_text_width", "reply_to_status_id", "reply_to_user_id", 
"reply_to_screen_name", "is_quote", "is_retweet", "favorite_count", 
"retweet_count", "hashtags", "symbols", "urls_url", "urls_t.co", 
"urls_expanded_url", "media_url", "media_t.co", "media_expanded_url", 
"media_type", "ext_media_url", "ext_media_t.co", "ext_media_expanded_url", 
"ext_media_type", "mentions_user_id", "mentions_screen_name", 
"lang", "quoted_status_id", "quoted_text", "quoted_created_at", 
"quoted_source", "quoted_favorite_count", "quoted_retweet_count", 
"quoted_user_id", "quoted_screen_name", "quoted_name", "quoted_followers_count", 
"quoted_friends_count", "quoted_statuses_count", "quoted_location", 
"quoted_description", "quoted_verified", "retweet_status_id", 
"retweet_text", "retweet_created_at", "retweet_source", "retweet_favorite_count", 
"retweet_retweet_count", "retweet_user_id", "retweet_screen_name", 
"retweet_name", "retweet_followers_count", "retweet_friends_count", 
"retweet_statuses_count", "retweet_location", "retweet_description", 
"retweet_verified", "place_url", "place_name", "place_full_name", 
"place_type", "country", "country_code", "geo_coords", "coords_coords", 
"bbox_coords", "status_url", "name", "location", "description", 
"url", "protected", "followers_count", "friends_count", "listed_count", 
"statuses_count", "favourites_count", "account_created_at", "verified", 
"profile_url", "profile_expanded_url", "account_lang", "profile_banner_url", 
"profile_background_url", "profile_image_url", "date", "is_sync", 
"type")

```

# RQ1: Activity

## Activity statistics and tests

```{r}
# number of sync vs. async tweets
df_ss %>% nrow()  # total number of tweets
sync_n <- df_ss %>% count(is_sync) %>% filter(is_sync==1) %>% pull(n)
async_n <- df_ss %>% count(is_sync) %>% filter(is_sync==0) %>% pull(n)
sync_n; async_n

(sync_n + async_n) - (df_ss %>% nrow())  # make sure all rows are accounted for

# test if difference is significant
chisq.test(c(sync_n, async_n))

df_ss %>% 
    group_by(is_sync) %>% 
    summarize(unique_tweeters =
                  {screen_name %>% tolower %>% unique %>% length} # I'd suggest avoiding this if possible; one way may be to mutate the variable to be formatted the way you need it to before you get to the summarize
              )

chisq.test(c(8974, 1325))

df_ss %>% 
    filter(type == "ORIG") %>% 
    count(is_sync) %>% 
    group_by(is_sync) %>% 
    summarize(mean_n = mean(n))

df_ss %>% 
    filter(type == "ORIG") %>% 
    count(is_sync, screen_name) %>% 
    rename(number_of_orig_tweets = n) %>%  
    t_test(number_of_orig_tweets, is_sync)

df_ss %>% 
    count(is_sync, screen_name, type) %>% 
    complete(is_sync, screen_name, type, fill = list(n = 0)) %>% 
    filter(type == "ORIG") %>% 
    rename(number_of_orig_tweets = n) %>%  
    t_test(number_of_orig_tweets, is_sync)
```

## Activity Plot: Sync vs. Async

```{r}
df_ss$date_r <- df_ss$date %>% floor_date("day")

to_plot <- df_ss %>% count(date_r, is_sync) %>% as.data.frame %>%
    tidyr::complete(date_r, is_sync, fill = list(n = 0)) %>%
    filter(date_r != ymd("2015-08-31")) %>%
    mutate(date_r = date_r %>% as_date,
           during_sync_chat = as.factor(is_sync)
           ) 
levels(to_plot$during_sync_chat) <- c('Not During a Chat (Asynchronous)',
                                      'During a Chat (Synchronous)')

ggplot(to_plot, aes(x = date_r, y = n,
                    group = during_sync_chat,
                    color = during_sync_chat)) +
    geom_point(size = 1.25) +
    geom_line(size = .7) +
    scale_color_brewer("", type = "qual", palette = 6) +
    xlab(NULL) +
    ylab("Number of Tweets") +
    scale_x_date(breaks = seq(as.Date("2015-09-01", tz = "America/Detroit"),
                              as.Date("2016-08-31", tz = "America/Detroit"),
                              by = "2 months"),
                 date_labels = "%b %g") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(legend.position = "bottom")

ggsave("async-sync-time-series.png", width = 7, height = 5)
```

# RQ2: Content

## Content Plot: Sync vs. Async

```{r}
liwc <- read_csv("snyc_async_tweets_liwc.csv")
liwc <- rename(liwc, tweet_link = `Source (A)`)
liwc_df <- liwc %>% left_join(df_ss)

liwc_df %>% 
    select(is_sync, 
           affect,
           social,
           cogproc,
           percept,
           bio,
           drives,
           time,
           work) %>% 
    rename(Affect = affect,
           Social = social,
           `Cognitive Processing` = cogproc,
           `Perceptual Processes` = percept,
           `Biological Processes` = bio,
           Drives = drives,
           `Time Orientation` = time,
           `Work-related Concerns` = work) %>% 
    filter(!is.na(is_sync)) %>% 
    group_by(is_sync) %>% 
    summarize_all(funs(mean, sd, n())) %>% 
    gather(key, val, -is_sync) %>% 
    separate(key, c("var", "stat"), sep = "\\_") %>% 
    spread(stat, val) %>% 
    mutate(se = sd / sqrt(n - 1)) %>% 
    mutate(is_sync = factor(is_sync, labels = c("Asynchronous", "Synchronous"))) %>% 
    ggplot(aes(x = reorder(var, mean), y = mean, fill = is_sync)) +
    geom_col(position = "dodge") +
    geom_errorbar(aes(ymin = mean - se, 
                      ymax = mean + se),
                  position = position_dodge()) +
    viridis::scale_fill_viridis("", discrete = T, option = "D") +
    coord_flip() +
    hrbrthemes::theme_ipsum(base_size = 14) +
    theme(legend.position="top") +
    xlab(NULL) +
    ylab("Mean Per Tweet")

#ggsave("content.png", width = 6.75, height = 7.75)

```

## Content descriptives and stats

```{r}
# affect
mean(liwc_df$affect)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(affect, is_sync)

# social
mean(liwc_df$social)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(social, is_sync)

# cogproc
mean(liwc_df$cogproc)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(cogproc, is_sync)

# percept
mean(liwc_df$percept)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(percept, is_sync)

# bio
mean(liwc_df$bio)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(bio, is_sync)

# drives
mean(liwc_df$drives)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(drives, is_sync)

# time orientation
mean(liwc_df$time)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(time, is_sync)

# relativity
mean(liwc_df$relativ)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(relativ, is_sync)

# personal concerns - work
mean(liwc_df$work)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(work, is_sync)

# informal
mean(liwc_df$informal)

liwc_df %>%
    filter(type == "ORIG") %>% 
    t_test(informal, is_sync)
```

# RQ3: Interactions

## Interactions Plot: Retweets, Likes, Mentions, Replies

### Plot we use

```{r}
df_ss$mentions_count <- sapply(str_split(df_ss$mentions_screen_name, " "), length)

df_ss %>% 
    select(is_sync, 
           favorite_count,
           retweet_count, 
           reply_count,
           mentions_count) %>% 
    rename(Likes = favorite_count,
           Retweets = retweet_count,
           Replies = scraped_num_replies,
           Mentions = num_non_reply_mentions) %>% 
    group_by(is_sync) %>% 
    summarize_all(funs(mean, sd, n())) %>% 
    gather(key, val, -is_sync) %>% 
    separate(key, c("var", "stat")) %>% 
    spread(stat, val) %>% 
    mutate(se = sd / sqrt(n - 1)) %>% 
    mutate(is_sync = factor(is_sync, labels = c("Asynchronous", "Synchronous"))) %>% 
    ggplot(aes(x = reorder(var, mean), y = mean, fill = is_sync)) +
    geom_col(position = "dodge") +
    geom_errorbar(aes(ymin = mean - se, 
                      ymax = mean + se),
                  position = position_dodge()) +
    viridis::scale_fill_viridis("", discrete = T, option = "D") +
    coord_flip() +
    hrbrthemes::theme_ipsum(base_size = 12) +
    theme(legend.position="top") +
    xlab(NULL) +
    ylab("Mean Per Tweet")

# ggsave("interactions.png", width = 5.5, height = 6)
```

### Not sure if we use this one so this code isn't run right now

```{r, eval = FALSE}
#df_orig <- df_ss %>% filter(type == "ORIG")

#df_orig %>%
    group_by(is_sync, type) %>% 
    select(is_sync, 
           favorites = scraped_num_favorites, 
           retweets = retweet_count, 
           replies = scraped_num_replies, 
           mentions = num_non_reply_mentions, 
           hashtag = num_hashtags) %>% 
        group_by(is_sync) %>% 
        summarize_all(mean) %>% 
        gather(key, val, -is_sync) %>% 
        mutate(is_sync = as.factor(is_sync)) %>% 
        ggplot(aes(x = reorder(key, val), y = val, fill = is_sync)) +
        geom_col(position = "dodge") + 
        coord_flip() +
        hrbrthemes::theme_ipsum()
```

## Interactions descriptives and statistical tests

```{r}

# t-test for favs
df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(favorite_count, is_sync)

# t-test for retweets
df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(retweet_count, is_sync)

# t-test for replies
df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(scraped_num_replies, is_sync)

# t-test for mentions
df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(num_non_reply_mentions, is_sync)

# chi-sq for quote tweets
df_ss %>% 
    filter(type == "QUOTE") %>% 
    count(is_sync)
chisq.test(c(8468, 1465))

# t-test for hashtags
df_ss %>% 
    filter(type == "ORIG") %>% 
    summarize(mean_num_hashtags = mean(num_hashtags))
df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(num_hashtags, is_sync)

# t-test for URLS
df_ss %>% 
    filter(type == "ORIG") %>% 
    summarize(mean_urls_hashtags = mean(num_urls))
df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(num_urls, is_sync)
```

# RQ4: Portals

## Portals plot

```{r}
df_ss$hashtags_count <- sapply(str_split(df_ss$hashtags, " "), length)
df_ss$urls_count <- sapply(str_split(df_ss$urls_url, " "), length)

df_ss %>% 
    select(is_sync, 
           num_hashtags,
           num_urls) %>% 
    rename(Hashtags = num_hashtags,
           URLs = num_urls) %>% 
    group_by(is_sync) %>% 
    summarize_all(funs(mean, sd, n())) %>% 
    gather(key, val, -is_sync) %>% 
    separate(key, c("var", "stat")) %>% 
    spread(stat, val) %>% 
    mutate(se = sd / sqrt(n - 1)) %>% 
    mutate(is_sync = factor(is_sync, labels = c("Asynchronous", "Synchronous"))) %>% 
    ggplot(aes(x = reorder(var, mean), y = mean, fill = is_sync)) +
    geom_col(position = "dodge") +
    geom_errorbar(aes(ymin = mean - se, 
                      ymax = mean + se),
                  position = position_dodge()) +
    viridis::scale_fill_viridis("", discrete = T, option = "D") +
    coord_flip() +
    hrbrthemes::theme_ipsum(base_size = 10) +
    theme(legend.position="top") +
    xlab(NULL) +
    ylab("Mean Per Tweet")

# ggsave("portals.png", width = 5, height = 4.35)
```

## Portals descriptive stats and statistical tests

```{r}
df_ss %>% 
    filter(type == "ORIG") %>% 
    summarize(mean_urls_hashtags = mean(num_urls))

df_ss %>% 
    filter(type == "ORIG") %>% 
    t_test(num_urls, is_sync)
```
